<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é©¬æ¥è¥¿äºšå†å²æ‹–æ‹½å¡«ç©ºæ¸¸æˆ</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            text-align: center;
            padding: 20px;
            color: #333;
        }

        .game-container {
            background-color: white;
            border-radius: 20px;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            border: 2px solid #4D96FF;
        }
        
        h1 {
            color: #4D96FF;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 15px;
        }
        
        .player-name {
            margin-bottom: 15px;
        }
        
        .player-name input {
            font-family: "Arial", sans-serif;
            font-size: 16px;
            padding: 8px 12px;
            border: 2px solid #4D96FF;
            border-radius: 15px;
            text-align: center;
            color: #333;
            width: 60%;
            max-width: 200px;
        }
        
        .selector-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .grade-selector, .unit-selector {
            width: 48%;
        }
        
        .grade-btn, .unit-btn {
            background-color: #4D96FF;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 8px 12px;
            margin: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        
        .grade-btn:hover, .unit-btn:hover {
            transform: scale(1.05);
        }
        
        .unit-btn.active {
            background-color: #6BCB77;
        }
        
        .problem-container {
            margin: 20px 0;
            font-size: 18px;
            color: #333;
            min-height: 40px;
            text-align: left;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 10px;
            position: relative;
        }
        
        .blank-space {
            display: inline-block;
            width: 150px;
            height: 40px;
            border: 2px dashed #4D96FF;
            border-radius: 5px;
            margin: 0 5px;
            vertical-align: middle;
            background-color: #f0f8ff;
        }
        
        .options-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .option {
            padding: 8px 15px;
            border: 2px solid #4D96FF;
            border-radius: 15px;
            cursor: move;
            transition: all 0.2s;
            background-color: white;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .option:hover {
            background-color: #e6f0ff;
        }
        
        .option.dragging {
            opacity: 0.5;
            transform: scale(1.1);
        }
        
        .blank-space.highlight {
            background-color: #e6f7ff;
            border-color: #6BCB77;
        }
        
        .blank-space.correct {
            background-color: #d4edda;
            border-color: #6BCB77;
        }
        
        .blank-space.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        
        .submit-btn {
            background-color: #6BCB77;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }
        
        .submit-btn:hover {
            transform: scale(1.05);
        }
        
        .submit-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .score {
            font-size: 20px;
            margin: 10px 0;
            color: #4D96FF;
        }
        
        .level {
            font-size: 20px;
            color: #4D96FF;
            margin: 5px 0;
        }
        
        .feedback {
            font-size: 18px;
            margin: 10px 0;
            min-height: 24px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .feedback.correct {
            color: #155724;
            background-color: #d4edda;
            animation: bounce 0.5s;
        }
        
        .feedback.incorrect {
            color: #721c24;
            background-color: #f8d7da;
            animation: shake 0.5s;
        }
        
        .explanation {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 16px;
            text-align: left;
            display: none;
            border-left: 4px solid #4D96FF;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .history {
            margin-top: 20px;
            border-top: 2px dashed #dee2e6;
            padding-top: 15px;
        }
        
        .history h3 {
            color: #4D96FF;
        }
        
        .history-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .history-btn {
            background-color: #e9ecef;
            border: none;
            border-radius: 15px;
            padding: 5px 12px;
            cursor: pointer;
        }
        
        .history-btn.active {
            background-color: #4D96FF;
            color: white;
        }
        
        .history-list {
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        
        .history-item {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .history-correct {
            color: #155724;
        }
        
        .history-incorrect {
            color: #721c24;
        }
        
        .summary {
            display: none;
            background-color: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #4D96FF;
            animation: fall linear forwards;
        }
        
        @keyframes fall {
            to { transform: translateY(100vh) rotate(360deg); }
        }
        
        .progress-container {
            width: 100%;
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 5px;
            background-color: #4D96FF;
            width: 0%;
            transition: width 0.3s;
        }
        
        .pronounce-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #4D96FF;
            padding: 0;
            margin-left: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .timer {
            font-size: 18px;
            color: #4D96FF;
            margin: 10px 0;
        }
        
        .question-text {
            display: inline;
        }
        
        .voice-status {
            margin-top: 10px;
            font-size: 14px;
            padding: 5px;
            border-radius: 5px;
        }
        
        .voice-unsupported {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .voice-supported {
            background-color: #d4edda;
            color: #155724;
        }
        
        .voice-loading {
            background-color: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>ğŸ“œ é©¬æ¥è¥¿äºšå†å²æ‹–æ‹½å¡«ç©ºæ¸¸æˆ ğŸ“œ</h1>
        <p class="subtitle">å¡«å†™åå­—å¹¶é€‰æ‹©å¹´çº§å’Œå•å…ƒå¼€å§‹æŒ‘æˆ˜å§ï¼</p>

        <div class="player-name">
            <input type="text" id="player-name" placeholder="è¾“å…¥ä½ çš„åå­—" maxlength="10">
        </div>
        
        <div class="selector-container">
            <div class="grade-selector">
                <h3>å¹´çº§é€‰æ‹©</h3>
                <button class="grade-btn" data-grade="5">äº”å¹´çº§</button>
            </div>
            
            <div class="unit-selector">
                <h3>å•å…ƒé€‰æ‹©</h3>
                <div id="unit-buttons">
                    <p>è¯·å…ˆé€‰æ‹©å¹´çº§</p>
                </div>
            </div>
        </div>
        
        <div class="timer" id="timer">æ—¶é—´: 0ç§’</div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div id="voice-status" class="voice-status voice-loading">æ­£åœ¨åˆå§‹åŒ–è¯­éŸ³åŠŸèƒ½...</div>
        
        <div class="level" id="level">å…³å¡: 1/10</div>
        <div class="score" id="score">å¾—åˆ†: 0</div>
        
        <div class="problem-container" id="problem-container">
            <div>è¯·é€‰æ‹©å¹´çº§å’Œå•å…ƒ</div>
        </div>
        
        <div class="options-container" id="options-container"></div>
        
        <button class="submit-btn" id="submit-answer" disabled>æäº¤ç­”æ¡ˆ</button>
        
        <div class="feedback" id="feedback"></div>
        <div class="explanation" id="explanation"></div>
        
        <div class="summary" id="summary">
            <h3>ğŸ‰ <span id="summary-player">ç©å®¶</span> æ­å–œé€šå…³ï¼ ğŸ‰</h3>
            <p>ä½ å®Œæˆäº†æ‰€æœ‰å…³å¡ï¼</p>
            <p id="final-score">æœ€ç»ˆå¾—åˆ†: 0</p>
            <p id="correct-rate">æ­£ç¡®ç‡: 0%</p>
            <p id="time-used">ç”¨æ—¶: 0ç§’</p>
            <button id="play-again">å†ç©ä¸€æ¬¡</button>
        </div>
        
        <div class="history">
            <h3>ğŸ“ ç­”é¢˜å†å²</h3>
            <div class="history-controls">
                <button class="history-btn active" id="show-all">å…¨éƒ¨</button>
                <button class="history-btn" id="show-correct">æ­£ç¡®</button>
                <button class="history-btn" id="show-incorrect">é”™è¯¯</button>
            </div>
            <div class="history-list" id="history-list">
                <p>è¿˜æ²¡æœ‰ç­”é¢˜è®°å½•å“¦~</p>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€å˜é‡
        let score = 0;
        let currentProblem = "";
        let correctAnswer = "";
        let history = [];
        let grade = 0;
        let unit = '';
        let currentLevel = 1;
        const maxLevel = 10;
        let usedProblems = [];
        let startTime;
        let timer;
        let playerName = 'ç©å®¶';
        let historyFilter = 'all';
        let blankSpaces = [];
        let draggedOption = null;
        let elapsedSeconds = 0;
        
        // è¯­éŸ³çŠ¶æ€å˜é‡
        let isSpeechSupported = false;
        let chineseVoiceAvailable = false;
        let voicesLoaded = false;
        
        // å•å…ƒé…ç½®
        const unitConfig = {
            '5': ['1.1 å›ä¸»æ˜¯æ”¿åºœçš„é¦–è„‘', '1.2 å·çš„ä¿æŠ¤ä¼', '1.3 æ•ˆå¿ å›ä¸»', '1.4 å›è‡£åè®®']
        };
        
        // äº”å¹´çº§é¢˜ç›®åº“
        const historyDragQuestions = {
            '1.1 å›ä¸»æ˜¯æ”¿åºœçš„é¦–è„‘': [
                {
                    question: "å·å…ƒé¦–ç”±______å§”ä»»ã€‚",
                    options: ["è‹ä¸¹", "å›½å®¶å…ƒé¦–", "é¦–ç›¸", "å·åŠ¡å¤§è‡£"],
                    answer: "å›½å®¶å…ƒé¦–",
                    explanation: "æ ¹æ®é©¬æ¥è¥¿äºšå®ªæ³•ï¼Œå·å…ƒé¦–ï¼ˆå¦‚è‹ä¸¹æˆ–æ‹‰æƒ¹ï¼‰çš„ä»»å‘½éœ€ç”±å›½å®¶æœ€é«˜å…ƒé¦–ï¼ˆYang di-Pertuan Agongï¼‰ç¡®è®¤ã€‚"
                },
                {
                    question: "______æˆ–è‹ä¸¹æ˜¯å·æ”¿åºœçš„é¦–è„‘ã€‚",
                    options: ["æ‹‰æƒ¹", "å›½ç‹", "æ€»ç»Ÿ", "å·é•¿"],
                    answer: "æ‹‰æƒ¹",
                    explanation: "åœ¨å›ä¸»åˆ¶å·å±ï¼ˆå¦‚æ£®ç¾å…°ã€ç»ç’ƒå¸‚ï¼‰ï¼Œå·æ”¿åºœé¦–è„‘çš„ç§°å·ä¸º'æ‹‰æƒ¹'ï¼ˆRajaï¼‰æˆ–'è‹ä¸¹'ï¼ˆSultanï¼‰ã€‚"
                },
                {
                    question: "é©¬æ¥è¥¿äºšå…±æœ‰______ä¸ªå·å±å®è¡Œå›ä¸»åˆ¶åº¦ã€‚",
                    options: ["ä¹", "åä¸‰", "ä¸ƒ", "äº”"],
                    answer: "ä¹",
                    explanation: "å…¨å›½13ä¸ªå·ä¸­ï¼Œ9ä¸ªå·ä¿ç•™ä¸–è¢­å›ä¸»åˆ¶ï¼ˆæŸ”ä½›ã€å‰æ‰“ç­‰ï¼‰ï¼Œå…¶ä½™4å·ï¼ˆé©¬å…­ç”²ã€æ§ŸåŸç­‰ï¼‰ç”±å·å…ƒé¦–ï¼ˆéä¸–è¢­ï¼‰æ²»ç†ã€‚"
                },
                {
                    question: "å›ä¸»åˆ¶åº¦æºäº______çš„é©¬æ¥ç‹å›½ä¼ ç»Ÿã€‚",
                    options: ["æ—©æœŸ", "åæœŸ", "ç°ä»£", "æ®–æ°‘æ—¶æœŸ"],
                    answer: "æ—©æœŸ",
                    explanation: "é©¬æ¥è¥¿äºšçš„å›ä¸»åˆ¶å¯è¿½æº¯è‡³15ä¸–çºªé©¬å…­ç”²ç‹æœï¼Œåå—å°åº¦æ–‡åŒ–å½±å“å½¢æˆ'æ‹‰æƒ¹'ä½“ç³»ã€‚"
                },
                {
                    question: "______æŒ‡çš„æ˜¯å›ä¸»ç»Ÿæ²»çš„å·å±æˆ–å›½å®¶ã€‚",
                    options: ["æ‹‰æƒ¹", "æ”¿åºœ", "è®®ä¼š", "å†…é˜"],
                    answer: "æ‹‰æƒ¹",
                    explanation: "'æ‹‰æƒ¹'ä¸€è¯å¹¿ä¹‰æŒ‡å›ä¸»ç»Ÿæ²»çš„é¢†åœŸï¼ˆå¦‚æ£®ç¾å…°çš„'æ‹‰æƒ¹åˆ¶åº¦'ï¼‰ï¼Œç‹­ä¹‰å³å›ä¸»æœ¬äººã€‚"
                },
                {
                    question: "æˆ‘å›½çš„å›ä¸»åˆ¶åº¦å§‹äºæ—©æœŸçš„______æ—¶ä»£ã€‚",
                    options: ["é©¬æ¥ç‹å›½", "æ®–æ°‘", "ç‹¬ç«‹", "ç°ä»£"],
                    answer: "é©¬æ¥ç‹å›½",
                    explanation: "é©¬æ¥è¥¿äºšå›ä¸»åˆ¶ï¼ˆå¦‚è‹ä¸¹åˆ¶åº¦ï¼‰æºè‡ª15ä¸–çºªé©¬æ¥ç‹æœï¼ˆå¦‚é©¬å…­ç”²è‹ä¸¹å›½ï¼‰çš„ä¼ ç»Ÿç»Ÿæ²»ä½“ç³»ã€‚"
                },
                {
                    question: "æ”¿åºœæŒ‡çš„æ˜¯å›ä¸»æ‰€ç»Ÿæ²»çš„______æˆ–å›½å®¶ã€‚",
                    options: ["å·å±", "åŸå¸‚", "åœ°åŒº", "ä¹¡æ‘"],
                    answer: "å·å±",
                    explanation: "åœ¨å›ä¸»åˆ¶å·å±ï¼ˆå¦‚æŸ”ä½›ã€é›ªå…°èªï¼‰ï¼Œæ”¿åºœç”±è‹ä¸¹æˆ–æ‹‰æƒ¹ä½œä¸ºè±¡å¾é¦–è„‘ï¼Œå®é™…è¡Œæ”¿ç”±å·åŠ¡å¤§è‡£ï¼ˆMenteri Besarï¼‰æ‰§è¡Œã€‚"
                },
                {
                    question: "åœ¨å›ä¸»åˆ¶åº¦ä¸‹ï¼Œæ‹‰æƒ¹æˆ–è‹ä¸¹æ˜¯æ”¿åºœçš„______ã€‚",
                    options: ["é¦–è„‘", "æˆå‘˜", "é¡¾é—®", "ä»£è¡¨"],
                    answer: "é¦–è„‘",
                    explanation: "è‹ä¸¹/æ‹‰æƒ¹æ˜¯å·å±çš„æ³•å®šç»Ÿæ²»è€…ï¼ˆHead of Stateï¼‰ï¼Œä½†æ—¥å¸¸è¡Œæ”¿ç”±æ°‘é€‰æ”¿åºœè´Ÿè´£ï¼Œå½¢æˆ'å›ä¸»ç«‹å®ªåˆ¶'ã€‚"
                },
                {
                    question: "å›ä¸»åˆ¶åº¦æ˜¯å›½å®¶çš„è±¡å¾ï¼Œä¹Ÿæ˜¯æˆ‘å›½é‡è¦çš„______ä¹‹ä¸€ã€‚",
                    options: ["é—äº§", "æ³•å¾‹", "æ”¿ç­–", "è®¡åˆ’"],
                    answer: "é—äº§",
                    explanation: "å›ä¸»åˆ¶è¢«åˆ—ä¸ºé©¬æ¥è¥¿äºšå›½å®¶æ–‡åŒ–é—äº§ï¼ˆå¦‚å®ªæ³•ç¬¬181æ¡ï¼‰ï¼Œä½“ç°å†å²å»¶ç»­æ€§ä¸æ°‘æ—å›¢ç»“ã€‚"
                },
                {
                    question: "æ—©æœŸé©¬æ¥ç‹å›½çš„______æ˜¯ä½é«˜æƒé‡çš„æ‹‰æƒ¹æˆ–è‹ä¸¹ï¼Œä¹Ÿæ˜¯è¯¥å·äººæ°‘çš„______ã€‚",
                    options: ["ç»Ÿæ²»è€…ï¼›ä¿æŠ¤ä¼", "é¢†è¢–ï¼›ä»†äºº", "å®˜å‘˜ï¼›æœ‹å‹", "ä»£è¡¨ï¼›ä¼™ä¼´"],
                    answer: "ç»Ÿæ²»è€…ï¼›ä¿æŠ¤ä¼",
                    explanation: "è‹ä¸¹/æ‹‰æƒ¹æ˜¯é©¬æ¥ç‹å›½çš„æœ€é«˜ç»Ÿæ²»è€…ã€‚å›ä¸»ä¼ ç»Ÿä¸Šè¢«è§†ä¸ºäººæ°‘çš„'ä¿æŠ¤è€…'ï¼ˆå¦‚æä¾›æ³•å¾‹åº‡æŠ¤ã€é¢†å¯¼å®—æ•™äº‹åŠ¡ï¼‰ã€‚"
                }
            ],
            '1.2 å·çš„ä¿æŠ¤ä¼': [
                {
                    question: "å·å…ƒé¦–ç”±______å§”ä»»ã€‚",
                    options: ["è‹ä¸¹", "å›½å®¶å…ƒé¦–", "é¦–ç›¸", "å·åŠ¡å¤§è‡£"],
                    answer: "å›½å®¶å…ƒé¦–",
                    explanation: "æ ¹æ®é©¬æ¥è¥¿äºšå®ªæ³•ï¼Œå·å…ƒé¦–ï¼ˆå¦‚é©¬å…­ç”²ã€æ§ŸåŸç­‰éå›ä¸»å·ï¼‰ç”±æœ€é«˜å…ƒé¦–ï¼ˆå›½å®¶å…ƒé¦–ï¼‰å§”ä»»ã€‚"
                },
                {
                    question: "______æˆ–è‹ä¸¹æ˜¯æ”¿åºœçš„é¦–è„‘ã€‚",
                    options: ["æ‹‰æƒ¹", "å›½ç‹", "æ€»ç»Ÿ", "å·é•¿"],
                    answer: "æ‹‰æƒ¹",
                    explanation: "åœ¨å›ä¸»åˆ¶å·å±ï¼ˆå¦‚ç»ç’ƒå¸‚ã€æ£®ç¾å…°ï¼‰ï¼Œæ”¿åºœé¦–è„‘çš„ç§°å·ä¸º'æ‹‰æƒ¹'æˆ–'è‹ä¸¹'ï¼Œé©¬æ¥è¥¿äºšä¸ä½¿ç”¨'å›½ç‹'ä¸€è¯ã€‚"
                },
                {
                    question: "æˆ‘å›½å…±æœ‰______ä¸ªå·å±å®è¡Œå›ä¸»åˆ¶åº¦ã€‚",
                    options: ["ä¹", "åä¸‰", "ä¸ƒ", "äº”"],
                    answer: "ä¹",
                    explanation: "å…¨å›½13ä¸ªå·ä¸­ï¼Œ9ä¸ªä¿ç•™ä¸–è¢­å›ä¸»åˆ¶ï¼ˆæŸ”ä½›ã€å‰æ‰“ç­‰ï¼‰ï¼Œå…¶ä½™4å·ç”±å·å…ƒé¦–æ²»ç†ã€‚"
                },
                {
                    question: "å›ä¸»åˆ¶åº¦æºäº______çš„é©¬æ¥ç‹å›½ã€‚",
                    options: ["æ—©æœŸ", "åæœŸ", "ç°ä»£", "æ®–æ°‘æ—¶æœŸ"],
                    answer: "æ—©æœŸ",
                    explanation: "å›ä¸»åˆ¶å¯è¿½æº¯è‡³15ä¸–çºªé©¬å…­ç”²ç‹æœï¼Œå±é©¬æ¥ç‹å›½æ—©æœŸä¼ ç»Ÿã€‚"
                },
                {
                    question: "______æŒ‡çš„æ˜¯å›ä¸»ç»Ÿæ²»çš„å·å±æˆ–å›½å®¶ã€‚",
                    options: ["æ‹‰æƒ¹", "æ”¿åºœ", "è®®ä¼š", "å†…é˜"],
                    answer: "æ‹‰æƒ¹",
                    explanation: "'æ‹‰æƒ¹'å¹¿ä¹‰æŒ‡å›ä¸»ç»Ÿæ²»çš„é¢†åœŸï¼ˆå¦‚æ£®ç¾å…°ï¼‰ï¼Œ'æ”¿åºœ'æŒ‡è¡Œæ”¿æœºæ„ï¼ŒäºŒè€…ä¸åŒã€‚"
                },
                {
                    question: "______æ˜¯çº³é—½è”é‚¦ç›´è¾–å¸‚çš„ç»Ÿæ²»è€…ã€‚",
                    options: ["è‹ä¸¹", "å›½å®¶å…ƒé¦–", "é¦–ç›¸", "å¸‚é•¿"],
                    answer: "å›½å®¶å…ƒé¦–",
                    explanation: "è”é‚¦ç›´è¾–åŒºï¼ˆçº³é—½ã€å‰éš†å¡ã€å¸ƒåŸï¼‰ç”±æœ€é«˜å…ƒé¦–ç›´æ¥ç®¡è¾–ï¼Œæ— åœ°æ–¹å›ä¸»ã€‚"
                },
                {
                    question: "æ£®ç¾å…°å·çš„ç»Ÿæ²»è€…è¢«ç§°ä¸º______ã€‚",
                    options: ["è‹ä¸¹", "æœ€é«˜ç»Ÿæ²»è€…", "å›½ç‹", "å·é•¿"],
                    answer: "æœ€é«˜ç»Ÿæ²»è€…",
                    explanation: "æ£®ç¾å…°é‡‡ç”¨ç‹¬ç‰¹ç§°å·'ä¸¥ç«¯/Yang di-Pertuan Besar'ï¼Œæºäºå†å²ä¸Šçš„éƒ¨è½è”ç›Ÿåˆ¶åº¦ã€‚"
                },
                {
                    question: "ç»ç’ƒå¸‚çš„é¦–è„‘ç§°ä¸º______ã€‚",
                    options: ["å·å…ƒé¦–", "æ‹‰æƒ¹", "è‹ä¸¹", "ç»Ÿæ²»è€…"],
                    answer: "æ‹‰æƒ¹",
                    explanation: "ç»ç’ƒå¸‚æ˜¯å›ä¸»åˆ¶å·å±ï¼Œå…¶ç»Ÿæ²»è€…ä¸º'æ‹‰æƒ¹'ï¼Œé'å·å…ƒé¦–'ï¼ˆåè€…ç”¨äºéå›ä¸»å·ï¼‰ã€‚"
                },
                {
                    question: "åœ¨æ²¡æœ‰è‹ä¸¹æˆ–æ‹‰æƒ¹çš„å·å±ï¼Œå·å…ƒé¦–æ˜¯ç”±______å§”ä»»çš„ã€‚",
                    options: ["å›½å®¶å…ƒé¦–", "é¦–ç›¸", "è®®ä¼š", "äººæ°‘"],
                    answer: "å›½å®¶å…ƒé¦–",
                    explanation: "å¦‚é©¬å…­ç”²ã€æ§ŸåŸç­‰å·çš„å·å…ƒé¦–ï¼ˆGovernorï¼‰ç”±æœ€é«˜å…ƒé¦–ä»»å‘½ã€‚"
                },
                {
                    question: "é›ªå…°èªå·å’Œå½­äº¨å·çš„ç»Ÿæ²»è€…æ˜¯______ã€‚",
                    options: ["è‹ä¸¹", "æ‹‰æƒ¹", "æœ€é«˜ç»Ÿæ²»è€…", "å·é•¿"],
                    answer: "è‹ä¸¹",
                    explanation: "ä¸¤å·å‡é‡‡ç”¨'è‹ä¸¹'ç§°å·ï¼Œå¦‚ç°ä»»é›ªå…°èªè‹ä¸¹æ²™æ‹‰å¼—ä¸æ®¿ä¸‹ã€‚"
                }
            ],
            '1.3 æ•ˆå¿ å›ä¸»': [
                {
                    question: "ã€Š______ã€‹ä¸­è®°è½½äº†å›ä¸»ä¸äººæ°‘çš„åè®®ã€‚",
                    options: ["é©¬æ¥çºªå¹´", "è”é‚¦å®ªæ³•", "å›½å®¶åŸåˆ™", "ç‹¬ç«‹å®£è¨€"],
                    answer: "é©¬æ¥çºªå¹´",
                    explanation: "ã€Šé©¬æ¥çºªå¹´ã€‹ï¼ˆSulalatus Salatinï¼‰æ˜¯è®°è½½é©¬æ¥ç‹æœå†å²çš„é‡è¦æ–‡çŒ®ã€‚"
                },
                {
                    question: "______ä¸äººæ°‘ä¹‹é—´çš„åè®®ï¼Œæ˜¯å»ºç«‹æ•ˆå¿ è¡Œä¸ºçš„åŸºç¡€ã€‚",
                    options: ["å›ä¸»", "é¦–ç›¸", "å·åŠ¡å¤§è‡£", "è®®ä¼š"],
                    answer: "å›ä¸»",
                    explanation: "åè®®åŒæ–¹ä¸ºå›ä¸»ï¼ˆæ–¯é‡Œå¾·é‡Œå¸ƒé˜¿çº³ï¼‰å’Œäººæ°‘ä»£è¡¨ï¼ˆå¾·èŠ’ä¹å·´å°”è¾¾æ¸©ï¼‰ã€‚"
                },
                {
                    question: "äººæ°‘______ç­”åº”æ•ˆå¿ å›ä¸»ï¼Œå›ä¸»åˆ™å…¬æ­£æ— ç§åœ°ç»Ÿæ²»äººæ°‘ã€‚",
                    options: ["å¾·èŠ’ä¹å·´å°”è¾¾æ¸©", "æ–¯é‡Œå¾·é‡Œå¸ƒé˜¿çº³", "é¦–ç›¸", "å·åŠ¡å¤§è‡£"],
                    answer: "å¾·èŠ’ä¹å·´å°”è¾¾æ¸©",
                    explanation: "å¾·èŠ’ä¹å·´å°”è¾¾æ¸©ä½œä¸ºäººæ°‘ä»£è¡¨ä¸å›ä¸»ç«‹çº¦ã€‚"
                },
                {
                    question: "åè®®ä¸­è•´å«äº†______ä¸èƒŒå›çš„æ¦‚å¿µã€‚",
                    options: ["å›æƒ", "æ°‘æƒ", "æ”¿æƒ", "æ³•æƒ"],
                    answer: "å›æƒ",
                    explanation: "å›æƒï¼ˆdaulatï¼‰æŒ‡å›ä¸»ç¥åœ£æƒå¨ï¼ŒèƒŒå›ï¼ˆderhakaï¼‰å³è¿åæ•ˆå¿ èª“è¨€ã€‚"
                },
                {
                    question: "è¯¥åè®®ç¡®ç«‹äº†é©¬æ¥ä¼ ç»Ÿæ”¿æ²»ä¸­______ä¸ä¹‰åŠ¡çš„ç›¸äº’å…³ç³»ã€‚",
                    options: ["æ•ˆå¿ ", "æƒåˆ©", "è‡ªç”±", "å¹³ç­‰"],
                    answer: "æ•ˆå¿ ",
                    explanation: "äººæ°‘æ•ˆå¿ å›ä¸»ï¼Œå›ä¸»ä¿éšœå…¬æ­£ç»Ÿæ²»ï¼Œå½¢æˆåŒå‘è´£ä»»ã€‚"
                },
                {
                    question: "æ–¯é‡Œå¾·é‡Œå¸ƒé˜¿çº³æ˜¯é©¬æ¥æ–‡çŒ®è®°è½½ä¸­çš„______è±¡å¾ã€‚",
                    options: ["å›æƒ", "æ°‘æƒ", "æ”¿æƒ", "æ³•æƒ"],
                    answer: "å›æƒ",
                    explanation: "å…¶åæ„ä¸º'å…‰è£çš„å›ä¸»'ï¼Œä»£è¡¨é©¬æ¥å›ä¸»çš„ç¥åœ£æ€§ã€‚"
                },
                {
                    question: "å¾·èŠ’ä¹å·´å°”è¾¾æ¸©çš„åå­—æ„ä¸º'______çš„ä½¿è€…'ã€‚",
                    options: ["äººæ°‘", "å›ä¸»", "å›½å®¶", "å®—æ•™"],
                    answer: "äººæ°‘",
                    explanation: "'Demang Lebar Daun'ç›´è¯‘ä¸º'å®½å¶é¦–é¢†'ï¼Œè±¡å¾äººæ°‘ä»£è¡¨ã€‚"
                },
                {
                    question: "è¿åæ•ˆå¿ åè®®çš„è¡Œä¸ºç§°ä¸º______ã€‚",
                    options: ["derhaka", "daulat", "khianat", "menderhaka"],
                    answer: "derhaka",
                    explanation: "èƒŒå›å›ä¸»åœ¨é©¬æ¥æ–‡åŒ–ä¸­æ˜¯æœ€ä¸¥é‡çš„ç½ªè¡Œä¹‹ä¸€ã€‚"
                },
                {
                    question: "å›ä¸»è‹¥è¿èƒŒå…¬æ­£ç»Ÿæ²»åŸåˆ™ï¼Œåˆ™å¯èƒ½å¤±å»______ã€‚",
                    options: ["daulat", "derhaka", "kuasa", "kedudukan"],
                    answer: "daulat",
                    explanation: "é©¬æ¥æ”¿æ²»å“²å­¦å¼ºè°ƒå›æƒä»¥å¾·è¡Œä¸ºåŸºç¡€ã€‚"
                },
                {
                    question: "ã€Šé©¬æ¥çºªå¹´ã€‹è®°è½½çš„è¿™ä¸€åè®®æˆä¸ºé©¬æ¥______åˆ¶åº¦çš„å…¸èŒƒã€‚",
                    options: ["å›è‡£", "æ°‘ä¸»", "è”é‚¦", "å…±å’Œ"],
                    answer: "å›è‡£",
                    explanation: "è¯¥åè®®å¥ å®šäº†ä¼ ç»Ÿé©¬æ¥ç¤¾ä¼š'æ•ˆå¿ -åº‡æŠ¤'å…³ç³»æ¨¡å¼ã€‚"
                }
            ],
            '1.4 å›è‡£åè®®': [
                {
                    question: "å›æƒï¼ˆdaulatï¼‰è±¡å¾å›ä¸»çš„______æƒåŠ›ï¼Œè¦æ±‚å›ä¸»å…·å¤‡______ã€______å’Œ______çš„å“å¾·ã€‚",
                    options: ["æ‰§æ”¿ï¼›è´¤æ˜ï¼›ç¿æ™ºç®¡ç†ï¼›é«˜å°š", "ç«‹æ³•ï¼›å…¬æ­£ï¼›å‹‡æ•¢ï¼›ä»æ…ˆ", "å¸æ³•ï¼›æ™ºæ…§ï¼›å®½å®¹ï¼›åšå®š", "è¡Œæ”¿ï¼›èªæ˜ï¼›è€å¿ƒï¼›è°¦è™š"],
                    answer: "æ‰§æ”¿ï¼›è´¤æ˜ï¼›ç¿æ™ºç®¡ç†ï¼›é«˜å°š",
                    explanation: "å›æƒä½“ç°å›ä¸»ç»Ÿæ²»çš„åˆæ³•æ€§ï¼Œéœ€ä»¥å¾·æ²»å›½ã€‚"
                },
                {
                    question: "èƒŒå›ï¼ˆderhakaï¼‰æŒ‡äººæ°‘______å›ä¸»çš„å‘½ä»¤ï¼Œè¿è€…å°†å—______ã€‚",
                    options: ["è¿èƒŒï¼›æƒ©ç½š", "éµå®ˆï¼›å¥–åŠ±", "å¿½è§†ï¼›è­¦å‘Š", "æ”¯æŒï¼›ä¿æŠ¤"],
                    answer: "è¿èƒŒï¼›æƒ©ç½š",
                    explanation: "èƒŒå›æ˜¯ç ´åå›è‡£å¥‘çº¦çš„è¡Œä¸ºã€‚"
                },
                {
                    question: "ç»´æŠ¤å›ä¸»åˆ¶åº¦çš„æ–¹æ³•åŒ…æ‹¬ï¼š______ã€______å’Œæ‚¬æŒ‚å…ƒé¦–è‚–åƒã€‚",
                    options: ["åº†ç¥è‹ä¸¹åè¯ï¼›å„æ—äººæ°‘å›¢ç»“ä¸€è‡´", "å‚åŠ é€‰ä¸¾ï¼›éµå®ˆæ³•å¾‹", "çº³ç¨ï¼›æœå…µå½¹", "å­¦ä¹ å†å²ï¼›ä¿æŠ¤æ–‡ç‰©"],
                    answer: "åº†ç¥è‹ä¸¹åè¯ï¼›å„æ—äººæ°‘å›¢ç»“ä¸€è‡´",
                    explanation: "é€šè¿‡ä»ªå¼ä¸å›¢ç»“å¼ºåŒ–åˆ¶åº¦è®¤åŒã€‚"
                },
                {
                    question: "ã€Š______ã€‹è®°è½½äº†å›ä¸»ä¸äººæ°‘çš„åè®®ï¼Œç¡®ç«‹______å¿…é¡»æ•ˆå¿ ã€______å¿…é¡»å…¬æ­£çš„åŒå‘è´£ä»»ã€‚",
                    options: ["é©¬æ¥çºªå¹´ï¼›äººæ°‘ï¼›å›ä¸»", "è”é‚¦å®ªæ³•ï¼›å…¬æ°‘ï¼›æ”¿åºœ", "å›½å®¶åŸåˆ™ï¼›äººæ°‘ï¼›å›½å®¶", "ç‹¬ç«‹å®£è¨€ï¼›æ°‘æ—ï¼›é¢†è¢–"],
                    answer: "é©¬æ¥çºªå¹´ï¼›äººæ°‘ï¼›å›ä¸»",
                    explanation: "è¯¥æ–‡çŒ®æ˜¯é©¬æ¥æ”¿æ²»å“²å­¦çš„åŸºç¡€ã€‚"
                },
                {
                    question: "è±¡å¾å›ä¸»æƒåŠ›çš„æ­£ç¡®é€‰é¡¹æ˜¯______ã€‚",
                    options: ["å›æƒ", "æ°‘æƒ", "æ”¿æƒ", "æ³•æƒ"],
                    answer: "å›æƒ",
                    explanation: "'daulat'ä¸“æŒ‡å›ä¸»ç¥åœ£ç»Ÿæ²»æƒï¼Œä¸'æ°‘æƒ'å¯¹ç«‹ã€‚"
                },
                {
                    question: "å›è‡£åè®®åæ˜ åœ¨å›½å®¶åŸåˆ™______ä¸­ã€‚",
                    options: ["å¿ äºå›å›½", "å°Šå´‡æ³•æ²»", "åŸ¹å…»å¾·è¡Œ", "ç»´æŠ¤å®ªæ³•"],
                    answer: "å¿ äºå›å›½",
                    explanation: "å›½å®¶åŸåˆ™ç¬¬äº”æ¡æ˜ç¡®æ•ˆå¿ å›ä¸»ä¸å›½å®¶çš„ä¹‰åŠ¡ã€‚"
                },
                {
                    question: "è®°è½½åè®®çš„æ–‡çŒ®æ˜¯______ã€‚",
                    options: ["ã€Šé©¬æ¥çºªå¹´ã€‹", "ã€Šè”é‚¦å®ªæ³•ã€‹", "ã€Šå›½å®¶åŸåˆ™ã€‹", "ã€Šç‹¬ç«‹å®£è¨€ã€‹"],
                    answer: "ã€Šé©¬æ¥çºªå¹´ã€‹",
                    explanation: "è¯¥æ–‡çŒ®è®°å½•æ–¯é‡Œå¾·é‡Œå¸ƒé˜¿çº³ä¸å¾·èŠ’ä¹å·´å°”è¾¾æ¸©çš„å¥‘çº¦ã€‚"
                },
                {
                    question: "èƒŒå›æŒ‡äººæ°‘______å›ä¸»å‘½ä»¤ã€‚",
                    options: ["è¿é€†", "éµå®ˆ", "å¿½è§†", "æ”¯æŒ"],
                    answer: "è¿é€†",
                    explanation: "'derhaka'ç‰¹æŒ‡è¿æŠ—å›ä¸»ï¼Œåæœä¸¥é‡ã€‚"
                },
                {
                    question: "æ•ˆå¿ å¯¹è±¡åº”ä¸º______ã€‚",
                    options: ["æ‹‰æƒ¹æˆ–è‹ä¸¹", "é¦–ç›¸", "å·åŠ¡å¤§è‡£", "è®®ä¼š"],
                    answer: "æ‹‰æƒ¹æˆ–è‹ä¸¹",
                    explanation: "å®ªæ³•è§„å®šå›ä¸»æ˜¯æ•ˆå¿ æ ¸å¿ƒï¼Œéæ”¿å…šæˆ–é¢†è¢–ã€‚"
                },
                {
                    question: "å›ä¸»è¡Œä½¿æƒåŠ›ä¾æ®______ã€‚",
                    options: ["è”é‚¦å®ªæ³•", "å·å®ªæ³•", "ä¹ æƒ¯æ³•", "å®—æ•™æ³•"],
                    answer: "è”é‚¦å®ªæ³•",
                    explanation: "ç°ä»£å›ä¸»æƒåŠ›å—å®ªæ³•æ˜æ–‡é™åˆ¶ã€‚"
                }
            ]
        };

        // åˆå§‹åŒ–è¯­éŸ³åˆæˆ
        function initSpeechSynthesis() {
            return new Promise((resolve) => {
                if (!('speechSynthesis' in window)) {
                    console.warn("æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆAPI");
                    updateVoiceStatus(false, "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨");
                    resolve(false);
                    return;
                }

                // æ£€æŸ¥è¯­éŸ³æ˜¯å¦å·²ç»åŠ è½½
                let voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    checkVoices(voices);
                    resolve(true);
                    return;
                }

                // è¯­éŸ³æœªåŠ è½½ï¼Œè®¾ç½®å›è°ƒ
                speechSynthesis.onvoiceschanged = function() {
                    voices = speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        checkVoices(voices);
                        resolve(true);
                    } else {
                        console.warn("æ— æ³•åŠ è½½è¯­éŸ³åˆ—è¡¨");
                        updateVoiceStatus(false, "æ— æ³•åŠ è½½è¯­éŸ³åˆ—è¡¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
                        resolve(false);
                    }
                };

                // æŸäº›æµè§ˆå™¨éœ€è¦è§¦å‘ä¸€æ¬¡getVoicesæ‰èƒ½æ¿€æ´»onvoiceschanged
                setTimeout(() => {
                    voices = speechSynthesis.getVoices();
                    if (voices.length === 0) {
                        updateVoiceStatus(false, "æ­£åœ¨åŠ è½½è¯­éŸ³å¼•æ“...");
                    }
                }, 100);
            });

            function checkVoices(voices) {
                // å¯»æ‰¾ä¸­æ–‡è¯­éŸ³
                chineseVoiceAvailable = voices.some(voice => 
                    voice.lang === 'zh-CN' || 
                    voice.lang === 'cmn-CN' || 
                    voice.lang.startsWith('zh-')
                );
                
                isSpeechSupported = true;
                voicesLoaded = true;
                
                if (chineseVoiceAvailable) {
                    updateVoiceStatus(true, "è¯­éŸ³åŠŸèƒ½å·²å¯ç”¨ (ä¸­æ–‡)");
                } else {
                    updateVoiceStatus(true, "è¯­éŸ³åŠŸèƒ½å·²å¯ç”¨ (ä½¿ç”¨é»˜è®¤è¯­éŸ³)");
                }
            }
        }

        // æ›´æ–°è¯­éŸ³çŠ¶æ€æ˜¾ç¤º
        function updateVoiceStatus(supported, message) {
            const voiceStatus = document.getElementById('voice-status');
            voiceStatus.textContent = message;
            
            if (supported) {
                voiceStatus.className = "voice-status voice-supported";
            } else {
                voiceStatus.className = "voice-status voice-unsupported";
            }
            
            voiceStatus.style.display = 'block';
        }

        // å‘éŸ³å‡½æ•° - å¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡å‘éŸ³
        function pronounceText(text) {
            if (!isSpeechSupported) {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨");
                return Promise.resolve();
            }

            return new Promise((resolve) => {
                // å–æ¶ˆå½“å‰æ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                
                // è®¾ç½®ä¸­æ–‡å‘éŸ³å‚æ•°
                utterance.lang = 'zh-CN'; // å¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡
                utterance.rate = 0.9;    // ç¨æ…¢çš„è¯­é€Ÿ
                utterance.pitch = 1;      // æ­£å¸¸éŸ³é«˜
                utterance.volume = 1;     // æœ€å¤§éŸ³é‡

                // è·å–æ‰€æœ‰å¯ç”¨è¯­éŸ³
                const voices = window.speechSynthesis.getVoices();
                
                // ä¼˜å…ˆé€‰æ‹©ä¸­æ–‡è¯­éŸ³
                const chineseVoices = voices.filter(v => 
                    v.lang === 'zh-CN' || 
                    v.lang === 'cmn-CN' || 
                    v.lang.startsWith('zh-')
                );
                
                // å¦‚æœæœ‰ä¸­æ–‡è¯­éŸ³åˆ™ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤è¯­éŸ³
                if (chineseVoices.length > 0) {
                    // ä¼˜å…ˆé€‰æ‹©å¥³æ€§å£°éŸ³ï¼ˆé€šå¸¸æ›´æ¸…æ™°ï¼‰
                    const femaleVoice = chineseVoices.find(v => v.name.includes('Female'));
                    utterance.voice = femaleVoice || chineseVoices[0];
                } else if (voices.length > 0) {
                    // æ²¡æœ‰ä¸­æ–‡è¯­éŸ³ï¼Œä½¿ç”¨é»˜è®¤è¯­éŸ³
                    utterance.voice = voices.find(v => v.default) || voices[0];
                    console.warn("æœªæ‰¾åˆ°ä¸­æ–‡è¯­éŸ³ï¼Œä½¿ç”¨é»˜è®¤è¯­éŸ³");
                }

                utterance.onend = function() {
                    resolve();
                };

                utterance.onerror = function(event) {
                    console.error('å‘éŸ³é”™è¯¯:', event.error);
                    alert("å‘éŸ³å¤±è´¥ï¼Œè¯·ç¡®ä¿æµè§ˆå™¨å…è®¸è¯­éŸ³åŠŸèƒ½");
                    resolve();
                };

                try {
                    window.speechSynthesis.speak(utterance);
                } catch (e) {
                    console.error("å‘éŸ³å¤±è´¥:", e);
                    alert("å‘éŸ³å¤±è´¥ï¼Œè¯·ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®åé‡è¯•");
                    resolve();
                }
            });
        }

        // è®¾ç½®å‘éŸ³æŒ‰é’®äº‹ä»¶
        function setupPronounceButtons() {
            document.querySelectorAll('.pronounce-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    
                    // è·å–è¦æœ—è¯»çš„æ–‡æœ¬
                    let text = '';
                    if (this.parentElement.classList.contains('option')) {
                        // é€‰é¡¹æŒ‰é’®
                        text = this.nextSibling.textContent;
                    } else {
                        // é—®é¢˜æŒ‰é’®
                        text = this.previousSibling.textContent;
                    }
                    
                    if (text.trim()) {
                        this.disabled = true;
                        this.innerHTML = 'âŒ›';
                        await pronounceText(text);
                        this.innerHTML = 'ğŸ”Š';
                        this.disabled = false;
                    }
                });
            });
        }

        // æ ¹æ®å¹´çº§å’Œå•å…ƒç”Ÿæˆé¢˜ç›®
        function generateProblem() {
            if (grade === 0 || unit === '' || currentLevel > maxLevel) return;
            
            let questions = historyDragQuestions[unit];
            
            // ç¡®ä¿é¢˜ç›®ä¸é‡å¤
            let questionIndex;
            do {
                questionIndex = Math.floor(Math.random() * questions.length);
            } while (usedProblems.includes(questionIndex) && usedProblems.length < questions.length);
            
            if (usedProblems.length >= questions.length) {
                // æ‰€æœ‰é¢˜ç›®éƒ½å·²ä½¿ç”¨è¿‡
                endGame(true);
                return;
            }
            
            usedProblems.push(questionIndex);
            const question = questions[questionIndex];
            
            currentProblem = question.question;
            correctAnswer = question.answer;
            
            // æ˜¾ç¤ºé¢˜ç›®
            const problemContainer = document.getElementById('problem-container');
            problemContainer.innerHTML = '';
            
            // åˆ›å»ºé¢˜ç›®æ–‡æœ¬ï¼Œå°†ç©ºç™½å¤„æ›¿æ¢ä¸ºå¯æ‹–æ‹½åŒºåŸŸ
            const questionParts = currentProblem.split('______');
            const blankSpace = document.createElement('span');
            blankSpace.className = 'blank-space';
            blankSpace.dataset.correctAnswer = correctAnswer;
            
            // æ·»åŠ æ‹–æ‹½äº‹ä»¶
            blankSpace.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('highlight');
            });
            
            blankSpace.addEventListener('dragleave', function() {
                this.classList.remove('highlight');
            });
            
            blankSpace.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('highlight');
                
                const draggedText = e.dataTransfer.getData('text/plain');
                this.textContent = draggedText;
                this.dataset.userAnswer = draggedText;
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç©ºç™½éƒ½å·²å¡«å†™
                checkAllBlanksFilled();
            });
            
            // æ·»åŠ ç¬¬ä¸€éƒ¨åˆ†é—®é¢˜å’Œå‘éŸ³æŒ‰é’®
            const firstPartContainer = document.createElement('span');
            firstPartContainer.className = 'question-text';
            
            const firstPartText = document.createTextNode(questionParts[0]);
            firstPartContainer.appendChild(firstPartText);
            
            if (questionParts[0].trim()) {
                const pronounceFirstBtn = document.createElement('button');
                pronounceFirstBtn.className = 'pronounce-btn';
                pronounceFirstBtn.innerHTML = 'ğŸ”Š';
                pronounceFirstBtn.title = 'æœ—è¯»é¢˜ç›®';
                firstPartContainer.appendChild(pronounceFirstBtn);
            }
            
            problemContainer.appendChild(firstPartContainer);
            problemContainer.appendChild(blankSpace);
            
            // å¦‚æœæœ‰ç¬¬äºŒéƒ¨åˆ†é—®é¢˜
            if (questionParts.length > 1) {
                const secondPartContainer = document.createElement('span');
                secondPartContainer.className = 'question-text';
                
                const secondPartText = document.createTextNode(questionParts[1]);
                secondPartContainer.appendChild(secondPartText);
                
                if (questionParts[1].trim()) {
                    const pronounceSecondBtn = document.createElement('button');
                    pronounceSecondBtn.className = 'pronounce-btn';
                    pronounceSecondBtn.innerHTML = 'ğŸ”Š';
                    pronounceSecondBtn.title = 'æœ—è¯»é¢˜ç›®';
                    secondPartContainer.appendChild(pronounceSecondBtn);
                }
                
                problemContainer.appendChild(secondPartContainer);
            }
            
            // å­˜å‚¨ç©ºç™½åŒºåŸŸå¼•ç”¨
            blankSpaces = [blankSpace];
            
            // æ˜¾ç¤ºè§£æ
            document.getElementById('explanation').textContent = question.explanation;
            document.getElementById('explanation').style.display = 'none';
            
            // åˆ›å»ºå¯æ‹–æ‹½é€‰é¡¹
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            // éšæœºæ’åºé€‰é¡¹
            const shuffledOptions = [...question.options].sort(() => Math.random() - 0.5);
            
            shuffledOptions.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.draggable = true;
                optionElement.dataset.option = option;
                
                // æ·»åŠ å‘éŸ³æŒ‰é’®
                const pronounceBtn = document.createElement('button');
                pronounceBtn.className = 'pronounce-btn';
                pronounceBtn.innerHTML = 'ğŸ”Š';
                pronounceBtn.title = 'æœ—è¯»é€‰é¡¹';
                
                // æ·»åŠ é€‰é¡¹æ–‡æœ¬
                const optionText = document.createElement('span');
                optionText.textContent = option;
                
                // æ·»åŠ æ‹–æ‹½äº‹ä»¶
                optionElement.addEventListener('dragstart', function(e) {
                    draggedOption = this;
                    e.dataTransfer.setData('text/plain', this.dataset.option);
                    this.classList.add('dragging');
                });
                
                optionElement.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
                
                // ç»„è£…é€‰é¡¹å…ƒç´ 
                optionElement.appendChild(pronounceBtn);
                optionElement.appendChild(optionText);
                optionsContainer.appendChild(optionElement);
            });
            
            // è®¾ç½®å‘éŸ³æŒ‰é’®äº‹ä»¶
            setupPronounceButtons();
            
            // è‡ªåŠ¨æœ—è¯»å®Œæ•´é—®é¢˜ï¼ˆå¯é€‰ï¼‰
            if (isSpeechSupported) {
                setTimeout(() => {
                    pronounceText(currentProblem.replace('______', 'ç©ºç™½'));
                }, 500);
            }
            
            // æ›´æ–°è¿›åº¦æ¡
            updateProgressBar();
        }

        // æ£€æŸ¥æ‰€æœ‰ç©ºç™½æ˜¯å¦å·²å¡«å†™
        function checkAllBlanksFilled() {
            const allFilled = blankSpaces.every(blank => blank.textContent.trim() !== '');
            document.getElementById('submit-answer').disabled = !allFilled;
        }
        
        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer() {
            let allCorrect = true;
            
            blankSpaces.forEach(blank => {
                const userAnswer = blank.dataset.userAnswer;
                const isCorrect = userAnswer === blank.dataset.correctAnswer;
                
                if (isCorrect) {
                    blank.classList.add('correct');
                    blank.classList.remove('incorrect');
                } else {
                    blank.classList.add('incorrect');
                    blank.classList.remove('correct');
                    allCorrect = false;
                }
            });
            
            const feedback = document.getElementById('feedback');
            const explanation = document.getElementById('explanation');
            
            if (allCorrect) {
                feedback.textContent = 'æ­£ç¡®ï¼å¤ªæ£’äº†ï¼ ğŸ‰';
                feedback.className = 'feedback correct';
                score += 10;
                document.getElementById('score').textContent = `å¾—åˆ†: ${score}`;
                
                // æ·»åŠ åˆ°å†å²è®°å½•
                addHistory(true, blankSpaces[0].dataset.userAnswer);
                
                // æ˜¾ç¤ºè§£æ
                explanation.style.display = 'block';
                
                // è¿›å…¥ä¸‹ä¸€å…³
                currentLevel++;
                document.getElementById('level').textContent = `å…³å¡: ${currentLevel}/${maxLevel}`;
                
                if (currentLevel > maxLevel) {
                    // é€šå…³
                    setTimeout(() => endGame(true), 1500);
                } else {
                    // ç”Ÿæˆæ–°é¢˜ç›®
                    setTimeout(() => {
                        document.getElementById('submit-answer').disabled = true;
                        generateProblem();
                    }, 1500);
                }
            } else {
                feedback.textContent = `å“å‘€ï¼Œä¸å¯¹å“¦ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯: ${correctAnswer}`;
                feedback.className = 'feedback incorrect';
                explanation.style.display = 'block';
                
                // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                blankSpaces.forEach(blank => {
                    blank.textContent = blank.dataset.correctAnswer;
                });
                
                // æ·»åŠ åˆ°å†å²è®°å½•
                addHistory(false, blankSpaces[0].dataset.userAnswer);
                
                // ç”Ÿæˆæ–°é¢˜ç›®ï¼ˆåŒä¸€å…³å¡ï¼‰
                setTimeout(() => {
                    document.getElementById('submit-answer').disabled = true;
                    generateProblem();
                }, 1500);
            }
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgressBar() {
            const progress = (currentLevel - 1) / maxLevel * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }
        
        // æ·»åŠ åˆ°å†å²è®°å½•
        function addHistory(isCorrect, userAnswer) {
            const historyItem = {
                problem: currentProblem,
                answer: correctAnswer,
                userAnswer: userAnswer,
                isCorrect: isCorrect,
                time: new Date().toLocaleTimeString()
            };
            
            history.unshift(historyItem);
            updateHistoryDisplay();
        }
        
        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                historyList.innerHTML = '<p>è¿˜æ²¡æœ‰ç­”é¢˜è®°å½•å“¦~</p>';
            } else {
                const filteredHistory = history.filter(item => {
                    if (historyFilter === 'all') return true;
                    if (historyFilter === 'correct') return item.isCorrect;
                    if (historyFilter === 'incorrect') return !item.isCorrect;
                    return true;
                });
                
                if (filteredHistory.length === 0) {
                    historyList.innerHTML = `<p>æ²¡æœ‰${historyFilter === 'correct' ? 'æ­£ç¡®' : 'é”™è¯¯'}çš„ç­”é¢˜è®°å½•~</p>`;
                } else {
                    filteredHistory.forEach(item => {
                        const historyItem = document.createElement('div');
                        historyItem.className = `history-item ${item.isCorrect ? 'history-correct' : 'history-incorrect'}`;
                        const icon = item.isCorrect ? 'âœ…' : 'âŒ';
                        historyItem.innerHTML = `
                            <strong>${icon} ${item.problem.replace('______', item.userAnswer)}</strong>
                            <br>
                            ä½ çš„ç­”æ¡ˆ: ${item.userAnswer} (æ­£ç¡®ç­”æ¡ˆ: ${item.answer}) (${item.time})
                        `;
                        historyList.appendChild(historyItem);
                    });
                }
            }
        }
        
        // è®¾ç½®å†å²ç­›é€‰
        function setHistoryFilter(filter) {
            historyFilter = filter;
            updateHistoryDisplay();
            
            document.getElementById('show-all').classList.remove('active');
            document.getElementById('show-correct').classList.remove('active');
            document.getElementById('show-incorrect').classList.remove('active');
            document.getElementById(`show-${filter}`).classList.add('active');
        }
        
        // æ›´æ–°å•å…ƒæŒ‰é’®
        function updateUnitButtons(selectedGrade) {
            const unitButtonsContainer = document.getElementById('unit-buttons');
            unitButtonsContainer.innerHTML = '';
            
            if (selectedGrade && unitConfig[selectedGrade]) {
                unitConfig[selectedGrade].forEach(unitName => {
                    const button = document.createElement('button');
                    button.className = 'unit-btn';
                    button.textContent = unitName;
                    button.dataset.unit = unitName;
                    button.addEventListener('click', function() {
                        document.querySelectorAll('.unit-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        this.classList.add('active');
                        unit = this.dataset.unit;
                        startGame(grade, unit);
                    });
                    unitButtonsContainer.appendChild(button);
                });
            } else {
                unitButtonsContainer.innerHTML = '<p>è¯·å…ˆé€‰æ‹©å¹´çº§</p>';
            }
        }
        
        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            elapsedSeconds = Math.floor((new Date() - startTime) / 1000);
            document.getElementById('timer').textContent = `æ—¶é—´: ${elapsedSeconds}ç§’`;
        }
        
        // å¼€å§‹æ¸¸æˆ
        async function startGame(selectedGrade, selectedUnit) {
            playerName = document.getElementById('player-name').value.trim() || 'ç©å®¶';
            document.getElementById('summary-player').textContent = playerName;
            
            grade = selectedGrade;
            unit = selectedUnit || '';
            score = 0;
            currentLevel = 1;
            history = [];
            usedProblems = [];
            blankSpaces = [];
            elapsedSeconds = 0;
            
            document.getElementById('score').textContent = `å¾—åˆ†: ${score}`;
            document.getElementById('level').textContent = `å…³å¡: ${currentLevel}/${maxLevel}`;
            document.getElementById('summary').style.display = 'none';
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('explanation').style.display = 'none';
            document.getElementById('submit-answer').disabled = true;
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('timer').textContent = 'æ—¶é—´: 0ç§’';
            
            // åˆå§‹åŒ–è¯­éŸ³
            await initSpeechSynthesis();
            
            // å¼€å§‹è®¡æ—¶
            startTime = new Date();
            if (timer) clearInterval(timer);
            timer = setInterval(updateTimer, 1000);
            
            generateProblem();
        }
        
        // ç»“æŸæ¸¸æˆ
        function endGame(isWin) {
            clearInterval(timer);
            window.speechSynthesis.cancel();
            
            if (isWin) {
                const correctCount = history.filter(item => item.isCorrect).length;
                const accuracy = Math.round((correctCount / history.length) * 100);
                
                document.getElementById('final-score').textContent = `æœ€ç»ˆå¾—åˆ†: ${score}`;
                document.getElementById('correct-rate').textContent = `æ­£ç¡®ç‡: ${accuracy}%`;
                document.getElementById('time-used').textContent = `ç”¨æ—¶: ${elapsedSeconds}ç§’`;
                document.getElementById('summary').style.display = 'block';
                
                createCelebration();
            }
        }
        
        // åˆ›å»ºåº†ç¥æ•ˆæœ
        function createCelebration() {
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            document.body.appendChild(celebration);
            
            // åˆ›å»ºå½©è‰²çº¸å±‘
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                celebration.appendChild(confetti);
            }
            
            setTimeout(() => celebration.remove(), 5000);
        }
        
        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // åˆå§‹åŒ–è¯­éŸ³
            await initSpeechSynthesis();
            
            // è®¾ç½®å¹´çº§é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.grade-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    grade = parseInt(this.dataset.grade);
                    updateUnitButtons(grade);
                    document.getElementById('problem-container').textContent = 'è¯·é€‰æ‹©å•å…ƒ';
                    document.getElementById('options-container').innerHTML = '';
                    document.getElementById('submit-answer').disabled = true;
                });
            });
            
            // å†å²ç­›é€‰æŒ‰é’®
            document.getElementById('show-all').addEventListener('click', () => setHistoryFilter('all'));
            document.getElementById('show-correct').addEventListener('click', () => setHistoryFilter('correct'));
            document.getElementById('show-incorrect').addEventListener('click', () => setHistoryFilter('incorrect'));
            
            // å†æ¥ä¸€æ¬¡æŒ‰é’®
            document.getElementById('play-again').addEventListener('click', function() {
                startGame(grade, unit);
            });
            
            // ç©å®¶å§“åè¾“å…¥
            document.getElementById('player-name').addEventListener('input', function() {
                playerName = this.value.trim() || 'ç©å®¶';
            });
            
            // æäº¤ç­”æ¡ˆæŒ‰é’®
            document.getElementById('submit-answer').addEventListener('click', checkAnswer);
            
            // é˜»æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            // iOSè®¾å¤‡éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½ä½¿ç”¨è¯­éŸ³
            document.body.addEventListener('click', function initOnClick() {
                if (!voicesLoaded && isSpeechSupported) {
                    initSpeechSynthesis();
                }
                document.body.removeEventListener('click', initOnClick);
            }, { once: true });
        });
    </script>
</body>
</html>